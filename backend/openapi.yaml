openapi: 3.0.3
info:
  title: Prompt Kaizen API
  description: Continuous Improvement Platform for AI Prompts
  version: 0.1.0
  contact:
    name: Prompt Kaizen

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://backend-hidden-field-9510.fly.dev/
    description: Prod development server

security:
  - UserIdHeader: []
  - ApiKeyHeader: []

paths:
  /prompts:
    post:
      summary: Create a new prompt
      operationId: createPrompt
      tags:
        - Prompts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePromptRequest'
      responses:
        '201':
          description: Prompt created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePromptResponse'
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
    get:
      summary: List all prompts for the authenticated user
      operationId: listPrompts
      tags:
        - Prompts
      responses:
        '200':
          description: List of user's prompts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PromptResponse'
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '500':
          description: Internal server error
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}:
    get:
      summary: Get a specific prompt
      operationId: getPrompt
      tags:
        - Prompts
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Prompt details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptResponse'
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Prompt not found or not owned by user
          content:
            text/plain:
              schema:
                type: string
    put:
      summary: Update a prompt
      operationId: updatePrompt
      tags:
        - Prompts
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePromptRequest'
      responses:
        '200':
          description: Prompt updated successfully
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Prompt not found or not owned by user
          content:
            text/plain:
              schema:
                type: string
    delete:
      summary: Delete a prompt
      operationId: deletePrompt
      tags:
        - Prompts
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Prompt deleted successfully
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Prompt not found or not owned by user
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}/versions:
    post:
      summary: Create a new version of a prompt
      operationId: createVersion
      tags:
        - Versions
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVersionRequest'
      responses:
        '201':
          description: Version created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateVersionResponse'
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Prompt not found or not owned by user
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}/versions/{version_id}:
    get:
      summary: Get a specific version
      operationId: getVersion
      tags:
        - Versions
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Version details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Version not found or prompt not owned by user
          content:
            text/plain:
              schema:
                type: string
    delete:
      summary: Delete a version
      operationId: deleteVersion
      tags:
        - Versions
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Version deleted successfully
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Version not found or prompt not owned by user
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}/tags:
    post:
      summary: Tag a specific version
      operationId: tagVersion
      tags:
        - Tags
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TagVersionRequest'
      responses:
        '200':
          description: Version tagged successfully
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Prompt not found or not owned by user
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}/tags/{tag_name}:
    delete:
      summary: Delete a tag
      operationId: deleteTag
      tags:
        - Tags
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: tag_name
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Tag deleted successfully
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Tag not found or prompt not owned by user
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}/tags/{tag_name}/version:
    get:
      summary: Get version by tag
      operationId: getVersionByTag
      tags:
        - Tags
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: tag_name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Version details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Tag or version not found, or prompt not owned by user
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}/feedback:
    post:
      summary: Submit feedback for a prompt version
      operationId: submitFeedback
      tags:
        - Feedback
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitFeedbackRequest'
      responses:
        '201':
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitFeedbackResponse'
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Prompt not found or not owned by user
          content:
            text/plain:
              schema:
                type: string

  /prompts/{prompt_id}/versions/{version_id}/feedback/{feedback_id}:
    put:
      summary: Update feedback
      operationId: updateFeedback
      tags:
        - Feedback
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: feedback_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateFeedbackRequest'
      responses:
        '200':
          description: Feedback updated successfully
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Feedback not found or prompt not owned by user
          content:
            text/plain:
              schema:
                type: string
    delete:
      summary: Delete feedback
      operationId: deleteFeedback
      tags:
        - Feedback
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: feedback_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Feedback deleted successfully
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Feedback not found or prompt not owned by user
          content:
            text/plain:
              schema:
                type: string

  /api-keys:
    post:
      summary: Create a new API key
      operationId: createApiKey
      tags:
        - API Keys
      security:
        - UserIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
    get:
      summary: List all API keys for the authenticated user
      operationId: listApiKeys
      tags:
        - API Keys
      security:
        - UserIdHeader: []
      responses:
        '200':
          description: List of user's API keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApiKeyResponse'
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '500':
          description: Internal server error
          content:
            text/plain:
              schema:
                type: string

  /api-keys/{api_key_id}:
    delete:
      summary: Delete an API key
      operationId: deleteApiKey
      tags:
        - API Keys
      security:
        - UserIdHeader: []
      parameters:
        - name: api_key_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: API key deleted successfully
        '401':
          description: Unauthorized - Missing or invalid user ID
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: API key not found or not owned by user
          content:
            text/plain:
              schema:
                type: string

components:
  securitySchemes:
    UserIdHeader:
      type: apiKey
      in: header
      name: x-user-id
      description: User ID for authentication (temporary until proper auth is implemented)
    ApiKeyHeader:
      type: apiKey
      in: header
      name: x-api-key
      description: API key for programmatic access (alternative to x-user-id)

  schemas:
    PromptResponse:
      type: object
      required:
        - id
        - user_id
        - name
        - created_at
        - updated_at
        - versions
        - tags
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
        name:
          type: string
          example: "My First Prompt"
        description:
          type: string
          nullable: true
          example: "Test prompt for MVP"
        created_at:
          type: string
          format: date-time
          example: "2024-01-31T12:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-31T12:30:00Z"
        versions:
          type: array
          items:
            $ref: '#/components/schemas/VersionResponse'
        tags:
          type: array
          items:
            $ref: '#/components/schemas/TagResponse'

    VersionResponse:
      type: object
      required:
        - id
        - version
        - digest
        - content
        - created_at
        - feedback_count
      properties:
        id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440000"
        version:
          type: string
          pattern: '^\d+\.\d+\.\d+$'
          example: "0.0.1"
        digest:
          type: string
          example: "sha256:a3b2c1d4e5f6..."
          description: "SHA256 hash of the content"
        content:
          type: string
          example: "Hello {{name}}, you are a helpful assistant."
        changelog:
          type: string
          nullable: true
          example: "Initial version"
        created_at:
          type: string
          format: date-time
          example: "2024-01-31T12:00:00Z"
        average_rating:
          type: number
          format: float
          nullable: true
          example: 4.5
          description: "Average rating from all feedback"
        feedback_count:
          type: integer
          example: 10
          description: "Number of feedback submissions"

    TagResponse:
      type: object
      required:
        - id
        - name
        - version_id
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: "770e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "latest"
        version_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440000"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-31T12:30:00Z"

    FeedbackResponse:
      type: object
      required:
        - id
        - rating
        - created_at
      properties:
        id:
          type: string
          format: uuid
          example: "880e8400-e29b-41d4-a716-446655440000"
        rating:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
        comment:
          type: string
          nullable: true
          example: "Works great!"
        created_at:
          type: string
          format: date-time
          example: "2024-01-31T12:00:00Z"

    ApiKeyResponse:
      type: object
      required:
        - id
        - name
        - key_prefix
        - created_at
        - is_active
      properties:
        id:
          type: string
          format: uuid
          example: "990e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "Production n8n Integration"
        key_prefix:
          type: string
          example: "pk_live_abc123"
          description: "First few characters of the key for identification"
        last_used_at:
          type: string
          format: date-time
          nullable: true
          example: "2024-01-31T14:30:00Z"
        created_at:
          type: string
          format: date-time
          example: "2024-01-31T12:00:00Z"
        is_active:
          type: boolean
          example: true

    CreatePromptRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: "My First Prompt"
          minLength: 1
        description:
          type: string
          nullable: true
          example: "Test prompt for MVP"

    CreatePromptResponse:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

    UpdatePromptRequest:
      type: object
      properties:
        name:
          type: string
          nullable: true
          example: "Updated Prompt Name"
          minLength: 1
        description:
          type: string
          nullable: true
          example: "Updated description"

    CreateVersionRequest:
      type: object
      required:
        - version
        - content
      properties:
        version:
          type: string
          pattern: '^\d+\.\d+\.\d+$'
          example: "0.0.1"
        content:
          type: string
          example: "Hello {{name}}, you are a helpful assistant."
          minLength: 1
        changelog:
          type: string
          nullable: true
          example: "Initial version"

    CreateVersionResponse:
      type: object
      required:
        - version_id
      properties:
        version_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440000"

    TagVersionRequest:
      type: object
      required:
        - tag_name
        - version_id
      properties:
        tag_name:
          type: string
          example: "latest"
          minLength: 1
        version_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440000"

    SubmitFeedbackRequest:
      type: object
      required:
        - version_id
        - rating
      properties:
        version_id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440000"
        rating:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
        comment:
          type: string
          nullable: true
          example: "Works great!"

    SubmitFeedbackResponse:
      type: object
      required:
        - feedback_id
      properties:
        feedback_id:
          type: string
          format: uuid
          example: "770e8400-e29b-41d4-a716-446655440000"

    UpdateFeedbackRequest:
      type: object
      properties:
        rating:
          type: integer
          minimum: 1
          maximum: 5
          nullable: true
          example: 4
        comment:
          type: string
          nullable: true
          example: "Updated comment"

    CreateApiKeyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: "Production n8n Integration"
          minLength: 1
          description: "Friendly name to identify this API key"

    CreateApiKeyResponse:
      type: object
      required:
        - id
        - api_key
        - message
      properties:
        id:
          type: string
          format: uuid
          example: "990e8400-e29b-41d4-a716-446655440000"
        api_key:
          type: string
          example: "pk_live_1234567890abcdef1234567890abcdef"
          description: "The actual API key - only shown once!"
        message:
          type: string
          example: "Save this API key securely. You won't be able to see it again."