openapi: 3.0.3
info:
  title: Prompt Kaizen API
  description: Continuous Improvement Platform for AI Prompts
  version: 0.1.0
  contact:
    name: Prompt Kaizen

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://backend-hidden-field-9510.fly.dev/
    description: Prod development server

security:
  - UserIdHeader: []
  - ApiKeyHeader: []

paths:
  /prompts:
    post:
      summary: Create a new prompt
      operationId: createPrompt
      tags:
        - Prompts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePromptRequest'
      responses:
        '201':
          description: Prompt created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePromptResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
    get:
      summary: List all prompts for the authenticated user
      operationId: listPrompts
      tags:
        - Prompts
      responses:
        '200':
          description: List of user's prompts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PromptResponse'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error

  /prompts/{prompt_id}:
    get:
      summary: Get a specific prompt
      operationId: getPrompt
      tags:
        - Prompts
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Prompt details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptResponse'
        '401':
          description: Unauthorized
        '404':
          description: Prompt not found
    put:
      summary: Update a prompt
      operationId: updatePrompt
      tags:
        - Prompts
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePromptRequest'
      responses:
        '200':
          description: Prompt updated successfully
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Prompt not found
    delete:
      summary: Delete a prompt
      operationId: deletePrompt
      tags:
        - Prompts
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Prompt deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: Prompt not found

  /prompts/{prompt_id}/versions:
    post:
      summary: Create a new version
      operationId: createVersion
      tags:
        - Versions
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVersionRequest'
      responses:
        '201':
          description: Version created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateVersionResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Prompt not found

  /prompts/{prompt_id}/versions/{version_id}:
    get:
      summary: Get a specific version
      operationId: getVersion
      tags:
        - Versions
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Version details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'
        '401':
          description: Unauthorized
        '404':
          description: Version not found
    delete:
      summary: Delete a version
      operationId: deleteVersion
      tags:
        - Versions
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Version deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: Version not found

  /prompts/{prompt_id}/versions/{version_id}/render:
    post:
      summary: Render a version with context variables
      operationId: renderVersion
      tags:
        - Versions
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenderVersionRequest'
      responses:
        '200':
          description: Rendered content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RenderVersionResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Version not found

  /prompts/{prompt_id}/tags:
    post:
      summary: Tag a specific version
      operationId: tagVersion
      tags:
        - Tags
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TagVersionRequest'
      responses:
        '200':
          description: Version tagged successfully
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Prompt not found

  /prompts/{prompt_id}/tags/{tag_name}:
    delete:
      summary: Delete a tag
      operationId: deleteTag
      tags:
        - Tags
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: tag_name
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Tag deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: Tag not found

  /prompts/{prompt_id}/tags/{tag_name}/version:
    get:
      summary: Get version by tag
      operationId: getVersionByTag
      tags:
        - Tags
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: tag_name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Version details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'
        '401':
          description: Unauthorized
        '404':
          description: Tag or version not found

  /prompts/{prompt_id}/tags/{tag_name}/render:
    post:
      summary: Render a version by tag with context variables
      operationId: renderVersionByTag
      tags:
        - Tags
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: tag_name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenderVersionRequest'
      responses:
        '200':
          description: Rendered content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RenderVersionResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Tag not found

  /prompts/{prompt_id}/feedback:
    post:
      summary: Submit feedback for a version
      operationId: submitFeedback
      tags:
        - Feedback
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitFeedbackRequest'
      responses:
        '201':
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitFeedbackResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Prompt not found

  /prompts/{prompt_id}/versions/{version_id}/feedback/{feedback_id}:
    put:
      summary: Update feedback
      operationId: updateFeedback
      tags:
        - Feedback
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: feedback_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateFeedbackRequest'
      responses:
        '200':
          description: Feedback updated successfully
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Feedback not found
    delete:
      summary: Delete feedback
      operationId: deleteFeedback
      tags:
        - Feedback
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: feedback_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Feedback deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: Feedback not found

  /api-keys:
    post:
      summary: Create a new API key
      operationId: createApiKey
      tags:
        - API Keys
      security:
        - UserIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
    get:
      summary: List all API keys
      operationId: listApiKeys
      tags:
        - API Keys
      security:
        - UserIdHeader: []
      responses:
        '200':
          description: List of user's API keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApiKeyResponse'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error

  /api-keys/{api_key_id}:
    delete:
      summary: Delete an API key
      operationId: deleteApiKey
      tags:
        - API Keys
      security:
        - UserIdHeader: []
      parameters:
        - name: api_key_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: API key deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: API key not found

  /prompts/{prompt_id}/improvements:
    post:
      summary: Create improvement suggestion
      operationId: createImprovementSuggestion
      tags:
        - Improvements
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateImprovementSuggestionRequest'
      responses:
        '201':
          description: Improvement suggestion created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateImprovementSuggestionResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Prompt not found

  /prompts/{prompt_id}/versions/{version_id}/improvements:
    get:
      summary: List improvement suggestions for version
      operationId: listSuggestionsForVersion
      tags:
        - Improvements
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of improvement suggestions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ImprovementSuggestionResponse'
        '401':
          description: Unauthorized
        '404':
          description: Version not found

  /prompts/{prompt_id}/versions/{version_id}/improvements/{suggestion_id}/accept:
    post:
      summary: Accept improvement suggestion
      operationId: acceptImprovementSuggestion
      tags:
        - Improvements
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: suggestion_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcceptImprovementSuggestionRequest'
      responses:
        '200':
          description: Suggestion accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcceptImprovementSuggestionResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Suggestion not found

  /prompts/{prompt_id}/versions/{version_id}/improvements/{suggestion_id}/decline:
    post:
      summary: Decline improvement suggestion
      operationId: declineImprovementSuggestion
      tags:
        - Improvements
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: suggestion_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeclineImprovementSuggestionRequest'
      responses:
        '200':
          description: Suggestion declined
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Suggestion not found

  /prompts/{prompt_id}/versions/{version_id}/analyze-feedback:
    post:
      summary: Analyze feedback and generate improvement suggestion
      operationId: analyzeFeedback
      tags:
        - Improvements
      parameters:
        - name: prompt_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: version_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: AI suggestion generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyzeFeedbackResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Version not found
components:
  securitySchemes:
    UserIdHeader:
      type: apiKey
      in: header
      name: x-user-id
      description: User ID for authentication (temporary)
    ApiKeyHeader:
      type: apiKey
      in: header
      name: x-api-key
      description: API key for programmatic access

  schemas:
    PromptResponse:
      type: object
      required:
        - id
        - user_id
        - name
        - prompt_type
        - created_at
        - updated_at
        - versions
        - tags
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        prompt_type:
          type: string
          enum: [system, user]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        versions:
          type: array
          items:
            $ref: '#/components/schemas/VersionResponse'
        tags:
          type: array
          items:
            $ref: '#/components/schemas/TagResponse'

    VersionResponse:
      type: object
      required:
        - id
        - version
        - digest
        - content
        - content_type
        - created_at
        - feedback_count
        - feedback
        - improvement_suggestions
      properties:
        id:
          type: string
          format: uuid
        version:
          type: string
          pattern: '^\d+\.\d+\.\d+$'
        digest:
          type: string
          description: SHA256 hash of the content
        content:
          type: string
        content_type:
          type: string
          enum: [static, template]
        variables:
          type: array
          items:
            type: string
          nullable: true
        changelog:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        average_rating:
          type: number
          format: float
          nullable: true
        feedback_count:
          type: integer
        feedback:
          type: array
          items:
            $ref: '#/components/schemas/FeedbackResponse'
        improvement_suggestions:
          type: array
          items:
            $ref: '#/components/schemas/ImprovementSuggestionResponse'

    TagResponse:
      type: object
      required:
        - id
        - name
        - version_id
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        version_id:
          type: string
          format: uuid
        updated_at:
          type: string
          format: date-time

    TestScenarioResponse:
      type: object
      required:
        - input
        - actual_output
      properties:
        input:
          type: string
        actual_output:
          type: string
        expected_output:
          type: string
          nullable: true

    FeedbackResponse:
      type: object
      required:
        - id
        - rating
        - created_at
      properties:
        id:
          type: string
          format: uuid
        rating:
          type: integer
          minimum: 1
          maximum: 5
        comment:
          type: string
          nullable: true
        test_scenario:
          $ref: '#/components/schemas/TestScenarioResponse'
          nullable: true
        created_at:
          type: string
          format: date-time

    ApiKeyResponse:
      type: object
      required:
        - id
        - name
        - key_prefix
        - created_at
        - is_active
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        key_prefix:
          type: string
        last_used_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        is_active:
          type: boolean

    ImprovementSuggestionResponse:
      type: object
      required:
        - id
        - suggested_content
        - ai_rationale
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
        suggested_content:
          type: string
        ai_rationale:
          type: string
        status:
          type: string
          enum: [pending, accepted, declined]
        decline_reason:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
          nullable: true
        resulting_version_id:
          type: string
          format: uuid
          nullable: true

    CreatePromptRequest:
      type: object
      required:
        - name
        - prompt_type
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
          nullable: true
        prompt_type:
          type: string
          enum: [system, user]

    CreatePromptResponse:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          format: uuid

    UpdatePromptRequest:
      type: object
      properties:
        name:
          type: string
          nullable: true
          minLength: 1
        description:
          type: string
          nullable: true

    CreateVersionRequest:
      type: object
      required:
        - version
        - content
        - content_type
      properties:
        version:
          type: string
          pattern: '^\d+\.\d+\.\d+$'
        content:
          type: string
          minLength: 1
        content_type:
          type: string
          enum: [static, template]
        variables:
          type: array
          items:
            type: string
          nullable: true
        changelog:
          type: string
          nullable: true

    CreateVersionResponse:
      type: object
      required:
        - version_id
      properties:
        version_id:
          type: string
          format: uuid

    RenderVersionRequest:
      type: object
      properties:
        context:
          type: object
          nullable: true
          additionalProperties: true

    RenderVersionResponse:
      type: object
      required:
        - rendered_content
      properties:
        rendered_content:
          type: string

    TagVersionRequest:
      type: object
      required:
        - tag_name
        - version_id
      properties:
        tag_name:
          type: string
          minLength: 1
        version_id:
          type: string
          format: uuid

    SubmitFeedbackRequest:
      type: object
      required:
        - version_id
        - rating
      properties:
        version_id:
          type: string
          format: uuid
        rating:
          type: integer
          minimum: 1
          maximum: 5
        comment:
          type: string
          nullable: true
        test_input:
          type: string
          nullable: true
        test_actual_output:
          type: string
          nullable: true
        test_expected_output:
          type: string
          nullable: true

    SubmitFeedbackResponse:
      type: object
      required:
        - feedback_id
      properties:
        feedback_id:
          type: string
          format: uuid

    UpdateFeedbackRequest:
      type: object
      properties:
        rating:
          type: integer
          minimum: 1
          maximum: 5
          nullable: true
        comment:
          type: string
          nullable: true

    CreateApiKeyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1

    CreateApiKeyResponse:
      type: object
      required:
        - id
        - api_key
        - message
      properties:
        id:
          type: string
          format: uuid
        api_key:
          type: string
        message:
          type: string

    CreateImprovementSuggestionRequest:
      type: object
      required:
        - version_id
        - suggested_content
        - ai_rationale
      properties:
        version_id:
          type: string
          format: uuid
        suggested_content:
          type: string
        ai_rationale:
          type: string

    CreateImprovementSuggestionResponse:
      type: object
      required:
        - suggestion_id
      properties:
        suggestion_id:
          type: string
          format: uuid

    AcceptImprovementSuggestionRequest:
      type: object
      required:
        - new_version
      properties:
        new_version:
          type: string
          pattern: '^\d+\.\d+\.\d+$'
        changelog:
          type: string
          nullable: true

    AcceptImprovementSuggestionResponse:
      type: object
      required:
        - new_version_id
      properties:
        new_version_id:
          type: string
          format: uuid

    DeclineImprovementSuggestionRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string

    AnalyzeFeedbackResponse:
      type: object
      required:
        - suggestion_id
        - suggested_content
        - ai_rationale
      properties:
        suggestion_id:
          type: string
          format: uuid
        suggested_content:
          type: string
        ai_rationale:
          type: string